"use strict";(self.webpackChunkadvanced_db=self.webpackChunkadvanced_db||[]).push([[626],{68626:(e,t,s)=>{s.r(t),s.d(t,{SubActionBase:()=>N,default:()=>w});var a=s(89379),n=s(9950),r=s(73878),i=s(16673),o=s(58522),c=s(30720),l=s(38769),d=s(97554),h=s(12916),p=s(25045),u=s.n(p),m=s(32741),g=s(71968),f=s(56033),x=s(86665),_=s(4112),v=s(14535),S=s(20156),j=s(4695),b=s.n(j),A=s(22253),y=s(97747),C=s(42630),k=s(44414);class N extends S.ActionPlanBase{constructor(){super(...arguments),this.dateHandler=(e,t)=>{const{t:s}=this.props,{parentAction:a}=this.props;u()(e).isAfter(a.end_at)?b().fire({icon:"warning",title:s("Are you sure?"),className:"date-confirm-alert",text:s("You are about to select the date greater than parent action which it will change the date of parent action too."),showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:s("Yes"),cancelButtonText:s("Cancel")}).then(s=>{s.value?this.setState({[t]:e,[t+"_isGreater"]:!0}):this.setState({[t]:u()(a.end_at),[t+"_isGreater"]:!1})}):this.setState({[t]:e,[t+"_isGreater"]:!1})},this.updateParentActionDate=async()=>{const{parentAction:e}=this.props,{end_at:t}=this.state,s={query:g.Zr,variables:{action:{end_at:u()(t).isAfter(e.end_at)?u()(t).toISOString():e.end_at,start_at:e.start_at},action_id:e.id}};try{const e=await m.A.post("/graphql",s);if(null!==e&&void 0!==e&&e.data.data)return{success:!0}}catch(a){return console.log(a),{success:!1}}}}render(){throw"Function not implemented"}}const w=(0,r.Ng)(e=>({selectedWorkingGroup:e.selectedWorkingGroup}),e=>(0,o.zH)({fetchActionPlans:_.n},e))((0,i.y)((0,A.L)(class extends N{constructor(){super(...arguments),this.parentRef=(0,n.createRef)(),this.submitAction=async e=>{e.stopPropagation(),e.preventDefault();const{t:t}=this.props;this.setState({alerts:[],errors:{}});const{selectedWorkingGroup:s,parentAction:n}=this.props,{end_at:r,name:i,description:o,start_at:c,responsive_account_ids:l,end_at_isGreater:d,responsive_tags:h,allAccounts:p,attachments:f}=this.state,{id:x}=n,_=l.reduce((e,t)=>(p[t]?e.responsive_account_ids.push(t):e.responsive_tags.push(t),e),{responsive_tags:[],responsive_account_ids:[]}),j=[...new Set(_.responsive_tags.concat(h))],b={end_at:u()(r).endOf("day").toISOString(),start_at:u()(c).startOf("day").toISOString(),name:i,description:o||null,number:n.sub_actions.length,responsive_account_ids:_.responsive_account_ids.length?_.responsive_account_ids:[],responsive_tags:j.length?j:[]};if(c&&r&&i){const e=f||[],t=new FormData,s={query:g.Zj,variables:{sub_action:b,attachments:e.length?Array(e.length).fill(null):null,action_id:x}},a={};e.length>0&&Array(e.length).fill("").forEach((e,t)=>{a[t]=["variables.attachments.".concat(t)]}),t.append("operations",JSON.stringify(s)),t.append("map",JSON.stringify(a)),e.length>0&&Array(e.length).fill("").forEach((s,a)=>{t.append([a],e[a])});try{d&&await this.updateParentActionDate();const e=await m.A.post("/graphql",t);null!==e&&void 0!==e&&e.data.data&&(this.setState(S.initialState),this.props.fetchCurrentWorkingGroup(),this.props.modalHandler())}catch(C){if(C.message.includes("422")){var A,y;const{alerts:e,errors:t}=(0,v.Rb)(S.errorsConfig,null===(A=C.response.data.errors[0].extensions)||void 0===A||null===(y=A.validation)||void 0===y?void 0:y.sub_action);this.setState({alerts:e,errors:t})}}}else{let e={};["start_at","end_at","name"].forEach(s=>{this.state[s]||(e=(0,a.A)((0,a.A)({},e),{},{[s]:[t("Required field")]}))}),this.setState({alerts:[t("Fill all required fields")],errors:e})}}}render(){const{t:e}=this.props,{name:t,description:s,start_at:n,end_at:r,responsive_account_ids:i,responsive_tags:o,allAccounts:p,alerts:m,errors:g,showDummyModal:_,tagSearch:S,isStartAtFocused:j,isEndAtFocused:b,allTags:A}=this.state,{parentAction:N}=this.props,w=u()(N.start_at),D=u()(N.end_at);return(0,k.jsx)(k.Fragment,{children:(0,k.jsx)(c.aF,{title:e("Add subaction"),visible:this.props.visible&&!_,onOk:this.props.modalHandler,onCancel:this.props.modalHandler,footer:(0,k.jsxs)(c.fI,{gutter:[16],children:[(0,k.jsx)(c.fv,{span:12,children:(0,k.jsx)(f.$n,{className:"transparent cancel",type:"reset",onClick:this.props.modalHandler,children:e("Cancel")})}),(0,k.jsx)(c.fv,{span:12,children:(0,k.jsx)(f.$$,{className:"",tabIndex:"6",margin:"0px 0 0 10px",onClick:this.submitAction,children:e("Create a subaction")})})]}),zIndex:1080,children:(0,k.jsxs)("form",{id:"header",onSubmit:this.submitAction,children:[(0,k.jsx)(v.IM,{alerts:m}),(0,k.jsxs)(c.fI,{gutter:[22],children:[(0,k.jsx)(c.fv,{xs:24,children:(0,k.jsxs)(f.oi,{className:"has-messages",margin:"8px",align:"flex-end",children:[(0,k.jsx)(f.pd,{type:"text",name:"name",value:t,tabIndex:"1",autoFocus:!0,autoComplete:"off",id:"new-subaction-title",ref:e=>this.nameRef=e,className:"dynamic-input grey ".concat(t?"has-value":""),onChange:this.handleInput,hasErrors:g.name}),(0,k.jsx)("label",{htmlFor:"",onClick:()=>this.nameRef.focus(),children:e("Subaction name *")}),(0,k.jsx)(v.G,{name:"name",errors:g})]})}),(0,k.jsx)(c.fv,{xs:24,children:(0,k.jsxs)(c.fI,{gutter:[22],children:[(0,k.jsx)(c.fv,{span:12,children:(0,k.jsxs)(f.oi,{className:"has-messages",margin:"8px",align:"flex-end",children:[(0,k.jsx)(l.A,{required:!0,type:"date",name:"start_at",tabIndex:"2",getPopupContainer:e=>e.parentNode,value:n||null,placeholder:e("Start Date *"),ref:e=>this.start_atRef=e,open:j,onFocus:()=>this.setState({isStartAtFocused:!0}),onBlur:()=>this.setState({isStartAtFocused:!1}),onSelect:()=>this.setState({isStartAtFocused:!1}),disabledDate:e=>e<w||e>D,className:"custom-datepicker large grey ".concat(g.start_at&&"input-error"," ").concat(n?"has-value":""),onChange:e=>this.dateHandler(e?e.startOf("day"):null,"start_at")}),(0,k.jsx)(v.G,{name:"start_at",errors:g})]})}),(0,k.jsx)(c.fv,{span:12,children:(0,k.jsxs)(f.oi,{className:"has-messages",margin:"8px",align:"flex-end",children:[(0,k.jsx)(l.A,{required:!0,type:"date",name:"end_at",tabIndex:"3",getPopupContainer:e=>e.parentNode,value:r||null,placeholder:e("End Date *"),disabledDate:e=>e<u()(n).add(1,"day")||e<w,ref:e=>this.end_atRef=e,open:b,onFocus:()=>this.setState({isEndAtFocused:!0}),onBlur:()=>this.setState({isEndAtFocused:!1}),onSelect:()=>this.setState({isEndAtFocused:!1}),dateRender:(e,t)=>D.format("YYYY-MM-DD")===e.format("YYYY-MM-DD")?(0,k.jsx)("td",{title:e.format("YYYY-MM-DD"),className:"ant-picker-cell ant-picker-cell-in-view",children:(0,k.jsx)("div",{className:"ant-picker-cell-inner max-date",children:e.format("D")})}):(0,k.jsx)("td",{title:e.format("YYYY-MM-DD"),className:"ant-picker-cell ant-picker-cell-in-view",children:(0,k.jsx)("div",{className:"ant-picker-cell-inner",children:e.format("D")})}),className:"custom-datepicker large grey ".concat(g.end_at&&"input-error"," ").concat(r?"has-value":""),onChange:e=>this.dateHandler(e?e.endOf("day"):null,"end_at")}),(0,k.jsx)(v.G,{name:"end_at",errors:g})]})})]})}),(0,k.jsx)(c.fv,{span:24,children:(0,k.jsxs)(f.oi,{className:"has-messages",margin:"8px",align:"flex-end",children:[(0,k.jsx)(d.A,{mode:"multiple",required:!0,size:"large",tabIndex:"5",placeholder:e("Responsible Entity *"),value:[...new Set(i.concat(o))],onSearch:e=>this.setState({tagSearch:e}),style:{width:"100%",backgroundColor:"#fafbfc"},optionFilterProp:"children",allowClear:!0,showSearch:!0,onChange:e=>this.setState({responsive_account_ids:e}),className:"".concat((null===i||void 0===i?void 0:i.length)>0?"has-value":""," ").concat(g.responsive_account_ids&&"input-error"),getPopupContainer:e=>e.parentNode,menuItemSelectedIcon:(0,k.jsx)(x.h,{className:"check-icon"}),dropdownStyle:{backgroundColor:"#535263",padding:10},notFoundContent:null,defaultActiveFirstOption:!1,tagRender:function(e){const{label:t,value:s,closable:a,onClose:n}=e;return(0,k.jsx)(h.A,{closable:a,onClose:n,style:{marginRight:3,fontSize:16,padding:5},color:o.includes(s)?"blue":"default",children:t})},ref:e=>this.entityRef=e,onDeselect:e=>this.handleRemoveTag(e),onInputKeyDown:e=>{"Enter"===e.key&&S.trim().length&&(this.setState(e=>({responsive_tags:[...new Set([...e.responsive_tags,S])],tagSearch:""})),this.entityRef.blur(),this.entityRef.focus())},children:Object.values((0,a.A)((0,a.A)({},p),A)).map(e=>(0,k.jsxs)(d.A.Option,{className:"select-item",value:e.id,children:[e.isTag?"#":"","".concat(e.first_name||""," ").concat(e.last_name||"")]},e.id))}),(0,k.jsx)(v.G,{name:"responsive_account_ids",errors:g})]})},"responsive_accounts"),(0,k.jsx)(c.fv,{span:24,children:(0,k.jsxs)(f.oi,{className:"has-messages",margin:"8px",align:"flex-start",children:[(0,k.jsx)("label",{htmlFor:"",onClick:()=>{},children:e("Description")}),(0,k.jsx)(C.K,{height:150,value:s||"",onChange:e=>this.setState({description:e,errors:(0,v.Od)(this.state.errors,"description")}),className:"".concat(g.description&&"input-error")}),(0,k.jsx)(v.G,{name:"description",errors:g})]})}),(0,k.jsx)(c.fv,{span:24,children:(0,k.jsx)(y.A,{attachments:[],setAttachments:e=>this.setState({attachments:e})})})]})]})})})}})))}}]);